<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Doc Extractor + Slug/Image/MD Tool</title>
<style>
:root{
  --bg:#0f1724;
  --card:#0b1220;
  --muted:#94a3b8;
  --accent:#06b6d4;
  --white:#e6eef6;
}
body.light{
  --bg:#f5f5f5;
  --card:#ffffff;
  --muted:#555;
  --accent:#06b6d4;
  --white:#000;
}
*{box-sizing:border-box;}
body{margin:20px;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,var(--bg) 0%,#0b1220 100%);color:var(--white);}
.wrap{background:rgba(255,255,255,0.02);padding:20px;border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.7);margin-bottom:20px;}
body.light .wrap{background:var(--card);box-shadow:0 6px 15px rgba(0,0,0,0.1);}
h1{font-size:20px;margin:0 0 12px;}
p.note{color:var(--muted);margin:0 0 18px;}
textarea, div[contenteditable]{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--white);resize:none;overflow-y:auto;}
body.light textarea, body.light div[contenteditable]{border:1px solid #ccc;background:#fff;color:#000;}
textarea{min-height:120px;max-height:400px;}
button{background:var(--accent);border:none;color:#022;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600;}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white);}
body.light button.ghost{border:1px solid #ccc;color:#000;}
button.small{font-size:13px;padding:8px 10px;}
.result{white-space:pre-wrap;word-break:break-word;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;border:1px dashed rgba(255,255,255,0.04);min-height:120px;color:var(--white);}
body.light .result{background:#f9f9f9;border:1px dashed #ccc;color:#000;}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;margin-bottom:10px;}
label{font-size:13px;color:var(--muted);}
.row{display:flex;gap:8px;align-items:center;}
.options{display:flex;gap:8px;align-items:center;}
@media(max-width:880px){.flex-main{flex-direction:column;}.wrap{margin-bottom:20px;}}
.flex-main{display:flex;gap:20px;flex-wrap:wrap;}
.flex-left{flex:1;min-width:300px;max-width:600px;max-height:800px;overflow:auto;}
.flex-right{flex:2;min-width:400px;}
.editor-img{max-width:200px;margin:6px 0;display:block;}
.preview-img{max-width:150px;margin:6px;display:inline-block;}
.layer-preview{border:2px dashed #ccc;background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;min-height:120px;display:flex;flex-wrap:wrap;gap:6px;cursor:pointer;}
body.light .layer-preview{background:rgba(0,0,0,0.05);border:1px dashed #ccc;}
.toggle-container{margin-bottom:10px;}
</style>
</head>
<body>

<div class="toggle-container">
  <label><input type="checkbox" id="modeToggle"> Chế độ sáng / tối</label>
</div>

<div class="flex-main">
  <!-- Doc Extractor -->
  <div id="docContainer" class="flex-left wrap">
    <h1>Doc Extractor Tool</h1>
    <p class="note">Paste nội dung Google Docs vào dưới đây (hỗ trợ hình ảnh drag & drop/paste + Base64):</p>
    <div id="editor" contenteditable="true" style="min-height:150px; max-height:600px;"></div>
    <div class="controls">
      <label><input type="radio" name="extractMode" value="alt" checked> H1 + Alt</label>
      <label><input type="radio" name="extractMode" value="h2"> H1 + H2</label>
      <label>Số lượng H2: <input type="number" id="h2Limit" value="0" min="0" style="width:60px;"></label>
      <label><input type="checkbox" id="randomH2"> Random H2</label>
    </div>
    <div class="controls">
      <button id="extractBtn">Trích xuất</button>
      <button id="insertImgBtn">Chèn ảnh tự động</button>
    </div>
    <div id="docOutput" class="result" contenteditable="true"></div>
    <div class="footer">code by @chenchenhuang</div>
  </div>

  <!-- Các module khác -->
  <div class="flex-right">
    <!-- Slug Converter -->
    <div class="wrap">
      <h1>Slug Converter — chuyển tiêu đề → slug</h1>
      <textarea id="inputText" placeholder="Ví dụ: Liên Hệ SV388"></textarea>
      <div class="controls">
        <button id="convertBtn">Chuyển đổi</button>
        <button id="copyBtn">Copy</button>
        <button id="clearBtn" class="ghost small">Xóa</button>
      </div>
      <div id="outputArea" class="result" contenteditable="true"></div>
    </div>

    <!-- Image Converter -->
    <div class="wrap">
      <h1>JPG/PNG → WebP Converter</h1>
      <p class="note">Kéo thả hoặc chọn ảnh JPG/PNG để tự động tải WebP ZIP và chèn vào Doc Extractor.</p>
      <input type="file" id="imageInput" multiple accept="image/jpeg,image/png" style="display:none;">
      <div class="layer-preview" id="layerPreview">Kéo thả ảnh hoặc click vào đây để chọn ảnh</div>
      <div class="controls" style="margin-top:10px">
        <label for="qualityRange">Chất lượng:</label>
        <input type="range" id="qualityRange" min="0.1" max="1" step="0.1" value="0.8" />
        <span id="qualityVal">0.8</span>
        <button id="clearImgBtn" class="ghost">Xóa ảnh hiện tại</button>
      </div>
      <button id="downloadZipBtn" class="ghost" style="margin-top:8px;">Tải WebP ZIP</button>
    </div>

    <!-- MD Generator -->
    <div class="wrap">
      <h1>MD Generator</h1>
      <textarea id="mdInput" placeholder="Nhập danh sách tiêu đề mỗi dòng"></textarea>
      <div class="controls">
        <label><input type="radio" name="mdMode" value="plain" checked> md "text"</label>
        <label><input type="radio" name="mdMode" value="stt"> md "stt + text"</label>
        <button id="mdConvertBtn">Chuyển đổi</button>
        <button id="mdDownloadBtn" class="ghost">Tải .bat</button>
      </div>
      <div id="mdOutput" class="result" contenteditable="true"></div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
/* ===== Mode Toggle ===== */
document.getElementById('modeToggle').addEventListener('change', e=>{
  document.body.classList.toggle('light', e.target.checked);
});

/* ===== Slug Utility ===== */
function toSlug(text){ 
  const s=text.trim().toLowerCase(); 
  const from="àáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ"; 
  const to="aaaaaaaaaaaaaaaaaeeeeeeeeeeeiiiiiooooooooooooooooouuuuuuuuuuuyyyyyd"; 
  let r=""; 
  for(let i=0;i<s.length;i++){const idx=from.indexOf(s[i]);r+=idx>-1?to[idx]:s[i];} 
  return r.replace(/[^a-z0-9\s-]/g,'').replace(/[\s\-]+/g,'-').replace(/^\-+|\-+$/g,''); 
}

/* ===== Doc Extractor ===== */
let availableImages=[];
function extractContent(){
  const editor=document.getElementById('editor');
  let h1=''; let altList=[], h2List=[];
  const h1El=editor.querySelector('h1');
  if(h1El) h1=h1El.innerText.trim();
  else {const s=editor.querySelector('strong,b'); if(s) h1=s.innerText.trim();}
  editor.querySelectorAll('p, div, li, h2, h3').forEach(el=>{
    let hasItalic=false;
    el.querySelectorAll('*').forEach(n=>{if(window.getComputedStyle(n).fontStyle==='italic') hasItalic=true;});
    if(hasItalic) altList.push(el.innerText.trim());
  });
  document.querySelectorAll('input[name="extractMode"]')[1].checked?(
    h2List=Array.from(editor.querySelectorAll('h2')).map(e=>e.innerText.trim())
  ):null;
  const h2Limit=parseInt(document.getElementById('h2Limit').value);
  if(h2Limit>0) h2List=h2List.slice(0,h2Limit);
  return {h1,h2:h2List,alt:altList};
}

document.getElementById('extractBtn').onclick=()=>{
  const result=extractContent();
  const mode=document.querySelector('input[name="extractMode"]:checked').value;
  const outDiv=document.getElementById('docOutput'); outDiv.innerHTML='';
  if(mode==='alt'){
    const h1Div=document.createElement('div'); h1Div.textContent=result.h1; outDiv.appendChild(h1Div);
    result.alt.forEach(a=>{const div=document.createElement('div'); div.textContent=a; outDiv.appendChild(div);});
  } else {
    const h1Div=document.createElement('div'); h1Div.textContent=result.h1; outDiv.appendChild(h1Div);
    result.h2.forEach(h=>{const div=document.createElement('div'); div.textContent=h; outDiv.appendChild(div);});
  }
};

/* ===== Insert Images ===== */
function insertImagesToEditor(){
  const result=extractContent();
  const editor=document.getElementById('editor');
  const slugMap={};
  availableImages.forEach(img=>{ const name=img.name.replace(/\.[^/.]+$/,""); slugMap[name]=img.url; });

  // H1
  if(result.h1){
    const slug=toSlug(result.h1);
    const imgUrl = slugMap[slug];
    if(imgUrl){
      const h1El=editor.querySelector('h1') || editor.querySelector('strong,b');
      if(h1El){
        const next = h1El.nextElementSibling;
        if(!next || next.tagName!=='IMG' || next.src!==imgUrl){
          const img=document.createElement('img'); img.src=imgUrl; img.className='editor-img';
          h1El.after(img);
        }
      }
    }
  }

  // H2
  result.h2.forEach(h=>{
    const slug=toSlug(h);
    const imgUrl=slugMap[slug]; if(!imgUrl) return;
    const el=Array.from(editor.querySelectorAll('h2')).find(e=>e.innerText.trim()===h);
    if(el){
      const next=el.nextElementSibling;
      if(!next || next.tagName!=='IMG' || next.src!==imgUrl){
        const img=document.createElement('img'); img.src=imgUrl; img.className='editor-img';
        el.after(img);
      }
    }
  });

  // Alt
  result.alt.forEach(a=>{
    const slug=toSlug(a);
    const imgUrl=slugMap[slug]; if(!imgUrl) return;
    const el=Array.from(editor.querySelectorAll('p,div,li,h2,h3')).find(e=>e.innerText.trim()===a);
    if(el){
      const prev=el.previousElementSibling;
      if(!prev || prev.tagName!=='IMG' || prev.src!==imgUrl){
        const img=document.createElement('img'); img.src=imgUrl; img.className='editor-img';
        el.before(img);
      }
    }
  });
}
document.getElementById('insertImgBtn').onclick=insertImagesToEditor;

/* ===== Slug Converter ===== */
document.getElementById('convertBtn').onclick=()=>{
  const input=document.getElementById('inputText').value.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  const out=input.map(l=>toSlug(l)).join('\n');
  document.getElementById('outputArea').textContent=out;
};
document.getElementById('copyBtn').onclick=async()=>{
  const text=document.getElementById('outputArea').textContent;
  if(!text)return;
  try{await navigator.clipboard.writeText(text);}catch(e){alert('Copy thất bại');}
};
document.getElementById('clearBtn').onclick=()=>{document.getElementById('inputText').value='';document.getElementById('outputArea').textContent='';};

/* ===== Image Converter ===== */
const qualityRange=document.getElementById("qualityRange");
const qualityVal=document.getElementById("qualityVal");
qualityRange.oninput=()=>{qualityVal.textContent=qualityRange.value;};

const layerPreview=document.getElementById("layerPreview");
layerPreview.addEventListener('click',()=>{document.getElementById("imageInput").click();});
layerPreview.addEventListener('dragover', e=>{e.preventDefault();});
layerPreview.addEventListener('drop', e=>{
  e.preventDefault();
  handleFiles(e.dataTransfer.files);
});
document.getElementById("imageInput").addEventListener('change', e=>handleFiles(e.target.files));

function handleFiles(files){
  if(!files.length) return;
  availableImages=[]; layerPreview.innerHTML='';
  Array.from(files).forEach(file=>{
    const url=URL.createObjectURL(file);
    const img=document.createElement('img'); img.src=url; img.className='preview-img';
    layerPreview.appendChild(img);
    availableImages.push({name:file.name,url:url});
  });
  downloadWebpZip();
}

document.getElementById('clearImgBtn').onclick=()=>{
  availableImages=[]; layerPreview.innerHTML='Kéo thả ảnh hoặc click vào đây để chọn ảnh';
};

async function downloadWebpZip(){
  if(!availableImages.length) return;
  const zip=new JSZip();
  for(const img of availableImages){
    const resp=await fetch(img.url);
    const blob=await resp.blob();
    zip.file(img.name.replace(/\.[^/.]+$/,".webp"),blob);
  }
  const content=await zip.generateAsync({type:"blob"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(content); a.download="images.zip"; a.click();
}

/* ===== MD Generator ===== */
function removeDiacritics(str){
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/đ/g,"d").replace(/Đ/g,"D");
}
document.getElementById('mdConvertBtn').onclick=()=>{
  const lines=document.getElementById('mdInput').value.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  const mode=document.querySelector('input[name="mdMode"]:checked').value;
  const out=lines.map((l,i)=>mode==='stt'?`md "${i+1} ${removeDiacritics(l)}"`:`md "${removeDiacritics(l)}"`).join('\n');
  document.getElementById('mdOutput').textContent=out;
};
document.getElementById('mdDownloadBtn').onclick=()=>{
  const text=document.getElementById('mdOutput').textContent;
  if(!text){return;}
  const blob=new Blob([text],{type:'application/x-msdownload'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='md_output.bat'; a.click();
};
</script>
</body>
</html>
